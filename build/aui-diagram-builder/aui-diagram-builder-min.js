AUI.add("aui-diagram-builder-base",function(ai){var X=ai.Lang,d=X.isArray,ax=X.isBoolean,O=X.isNumber,F=X.isObject,aB=X.isString,M=function(A){return ai.instanceOf(A,ai.ArrayList);},V=function(A){return ai.instanceOf(A,ai.Node);},H=function(A){return ai.instanceOf(A,ai.AvailableField);},aK=ai.Array,Y="add",o="addNode",aJ="auto",P="availableField",T="availableFields",aG="availableFieldsDragConfig",v="boundingBox",aD="builder",ac="cancel",af="canvas",az="clearfix",f="column",a="container",ag="content",y="contentBox",e="contentContainer",S="contentNode",I="createDocumentFragment",D="diagram",ao="diagram-builder",ad="disk",r="draggable",aF="drop",ar="dropConfig",ab="dropContainer",aw="field",w="fields",q="fieldsContainer",av="height",s="helper",aa="icon",z="iconClass",aq="id",am="label",x="layout",ap="list",R="maxFields",u="node",g="parentNode",ah="propertyList",aE="rendered",at="save",t="settings",Q="tab",K="tabView",b="tabs",h="tabview",N="toolbar",m="toolbarContainer",C=ai.getClassName,aI=" ",i=".",j="#",aI=" ",E="_",n=C(f),B=C(D,aD,af),aj=C(D,aD,ag,a),G=C(D,aD,aF,a),ay=C(D,aD,aw),l=C(D,aD,aw,r),c=C(D,aD,aw,aa),ae=C(D,aD,aw,am),Z=C(D,aD,w,a),ak=C(D,aD,Q,Y),L=C(D,aD,Q,t),au=C(D,aD,b),U=C(D,aD,b,ag),an=C(D,aD,N,a),al=C(s,az),p=C(aa),J=C(x),aC=C(h,ag),aH=C(h,ap);var k=ai.Component.create({NAME:P,ATTRS:{draggable:{value:true,validator:ax},label:{validator:aB},iconClass:{validator:aB},id:{value:ai.guid(),setter:"_setId",validator:aB},node:{valueFn:function(aL){var A=this;if(!V(aL)){aL=ai.Node.create(ai.Lang.sub(A.FIELD_ITEM_TEMPLATE,{iconClass:A.get(z)}));aL.setData(P,A);}return aL;},validator:V,writeOnce:true},type:{value:u,validator:aB}},EXTENDS:ai.Base,buildNodeId:function(A){return T+E+aw+E+A;},getAvailableFieldById:function(A){return ai.AvailableField.getAvailableFieldByNode(j+ai.AvailableField.buildNodeId(A));},getAvailableFieldByNode:function(A){var A=ai.one(A);if(V(A)){return A.getData(P);}return null;},prototype:{FIELD_ITEM_TEMPLATE:'<li class="'+ay+'">'+'<span class="'+[p,c].join(aI)+' {iconClass}"></span>'+'<div class="'+ae+'"></div>'+"</li>",initializer:function(){var A=this;var aL=A.get(u);A.after({draggableChange:A._afterDraggableChange,idChange:A._afterIdChange,labelChange:A._afterLabelChange});A.labelNode=aL.one(i+ae);A._uiSetDraggable(A.get(r));A._uiSetId(A.get(aq));A._uiSetLabel(A.get(am));},_afterDraggableChange:function(aL){var A=this;A._uiSetDraggable(aL.newVal);},_afterIdChange:function(aL){var A=this;A._uiSetId(aL.newVal);},_afterLabelChange:function(aL){var A=this;A._uiSetLabel(aL.newVal);},_setId:function(A){return ai.AvailableField.buildNodeId(A);},_uiSetDraggable:function(aL){var A=this;A.get(u).toggleClass(l,aL);},_uiSetId:function(aL){var A=this;A.get(u).set(aq,aL);},_uiSetLabel:function(aL){var A=this;A.labelNode.setContent(aL);}}});ai.AvailableField=k;var W=function(){};W.ATTRS={fields:{value:[],setter:"_setFields",validator:function(A){return d(A)||M(A);}},maxFields:{value:Infinity,validator:O}};ai.mix(W.prototype,{_setFields:function(aL){var A=this;if(M(aL)){return aL;}else{return A.createFields(aL);}},_updateFields:function(aL){var A=this;A.set(w,aL);},addField:function(aM,aL){var A=this;if(A.get(w).size()<A.get(R)){var aN=A.createField(aM);if(aN){A._updateFields(A.get(w).add(aN,aL));}return aN;}return null;},createFields:function(aM){var aL=this;var A=[];aK.each(aM,function(aO,aN){if(aN<aL.get(R)){A.push(aL.createField(aO));}});return new ai.ArrayList(A);},removeField:function(aL){var A=this;A._updateFields(A.get(w).remove(aL));},createField:function(A){return A;}});ai.FieldSupport=W;var aA=ai.Component.create({NAME:ao,ATTRS:{availableFields:{setter:"_setAvailableFields",validator:d},availableFieldsDragConfig:{value:null,setter:"_setAvailableFieldsDragConfig",validator:F},canvas:{valueFn:function(){return ai.Node.create(this.CANVAS_TEMPLATE);}},dropConfig:{value:null,setter:"_setDropConfig",validator:F},contentContainer:{valueFn:function(){return ai.Node.create(this.CONTENT_CONTAINER_TEMPLATE);}},dropContainer:{valueFn:function(){return ai.Node.create(this.DROP_CONTAINER_TEMPLATE);}},fieldsContainer:{valueFn:function(){return ai.Node.create(this.FIELDS_CONTAINER_TEMPLATE);}},propertyList:{setter:"_setPropertyList",validator:F,value:null},strings:{value:{addNode:"Add node",cancel:"Cancel",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},tabView:{setter:"_setTabView",validator:F,value:null,writeOnce:true},toolbar:{setter:"_setToolbar",validator:F,value:null},toolbarContainer:{valueFn:function(){return ai.Node.create(this.TOOLBAR_CONTAINER_TEMPLATE);}}},HTML_PARSER:{contentContainer:i+aj,dropContainer:i+G,fieldsContainer:i+Z,toolbarContainer:i+an,canvas:i+B},UI_ATTRS:[T,w],AUGMENTS:[ai.FieldSupport],prototype:{CONTENT_CONTAINER_TEMPLATE:'<div class="'+aj+'"></div>',DROP_CONTAINER_TEMPLATE:'<div class="'+G+'"></div>',TOOLBAR_CONTAINER_TEMPLATE:'<div class="'+an+'"></div>',FIELDS_CONTAINER_TEMPLATE:'<ul class="'+[Z,al].join(aI)+'"></ul>',CANVAS_TEMPLATE:'<div tabindex="1" class="'+B+'"></div>',fieldsNode:null,propertyList:null,settingsNode:null,tabView:null,toolbar:null,initializer:function(){var A=this;A.publish({cancel:{defaultFn:A._defCancelFn}});A.after({render:A._afterRender,"recordset:update":A._afterRecordsetUpdate});A.after(A._afterUiSetHeight,A,"_uiSetHeight");A.canvas=A.get(af);A.contentContainer=A.get(e);A.dropContainer=A.get(ab);A.fieldsContainer=A.get(q);A.toolbarContainer=A.get(m);},isAvailableFieldsDrag:function(aM){var A=this;var aL=A.availableFieldsDrag;return(aM===aL.dd);},plotFields:function(){var aL=this;var A=aL.get(w);A.each(function(aM){aL.plotField(aM);});},renderUI:function(){var A=this;A._renderTabs();A._renderCanvas();A._uiSetAvailableFields(A.get(T));},syncUI:function(){var A=this;var aL=A.get(y);A._setupDrop();A._setupAvailableFieldsDrag();aL.addClass(J);},_afterActiveTabChange:function(aM){var A=this;var aL=aM.newVal.get(S);if(A.get(aE)&&(aL===A.settingsNode)){A._renderSettings();}},_afterRecordsetUpdate:function(aL){var A=this;
A._handleSaveEvent();},_afterRender:function(aL){var A=this;A.plotFields();},_afterUiSetHeight:function(aL){var A=this;A.contentContainer.setStyle(av,O(aL)?aL+A.DEF_UNIT:aL);A.dropContainer.setStyle(av,O(aL)?aL+A.DEF_UNIT:aL);},_defCancelFn:function(aL){var A=this;A.tabView.selectTab(0);},_handleCancelEvent:function(){var A=this;A.fire(ac);},_handleSaveEvent:function(){var A=this;A.fire(at);},_renderCanvas:function(){var A=this;var aL=A.get(y);var aM=A.canvas;var aN=A.contentContainer;var aO=A.dropContainer;if(!aM.inDoc()){aN.appendChild(aM);}if(!aO.inDoc()){aM.appendChild(aO);}if(aN.inDoc()){aN.get(g).append(aN);}else{aL.appendChild(aN);}},_renderPropertyList:function(){var A=this;if(!A.propertyList){A.propertyList=new ai.PropertyList(A.get(ah)).render(A.settingsNode);A.propertyList.get(v).unselectable();}},_renderSettings:function(){var A=this;A._renderPropertyList();A._renderToolbar();},_renderTabs:function(){var A=this;if(!A.tabView){var aL=new ai.TabView(A.get(K));aL.get(v);A.tabView=aL;A.fieldsNode=aL.getTab(0).get(S);A.settingsNode=aL.getTab(1).get(S);}},_renderToolbar:function(){var A=this;if(!A.toolbar){A.toolbar=new ai.Toolbar(A.get(N)).render(A.settingsNode);}},_setupDrop:function(){var A=this;A.drop=new ai.DD.Drop(A.get(ar));},_setupAvailableFieldsDrag:function(){var A=this;A.availableFieldsDrag=new ai.DD.Delegate(A.get(aG));},_setAvailableFields:function(aM){var aL=this;var A=[];aK.each(aM,function(aO,aN){A.push(H(aO)?aO:new ai.AvailableField(aO));});return A;},_setDropConfig:function(aL){var A=this;return ai.merge({bubbleTargets:A,groups:[T],node:A.dropContainer},aL||{});},_setAvailableFieldsDragConfig:function(aL){var A=this;return ai.merge({bubbleTargets:A,container:A.get(v),dragConfig:{groups:[T],plugins:[{cfg:{moveOnEnd:false},fn:ai.Plugin.DDProxy}]},nodes:i+l},aL||{});},_setPropertyList:function(aL){var A=this;return ai.merge({bubbleTargets:A,width:250,scroll:{height:400,width:aJ}},aL);},_setTabView:function(aO){var aL=this;var aN=aL.get(v);var aP=aN.one(i+aH);var aM={after:{activeTabChange:ai.bind(aL._afterActiveTabChange,aL)},boundingBox:aN.one(i+au),contentBox:aN.one(i+U),bubbleTargets:aL,contentNode:aN.one(i+aC),cssClass:au,listNode:aP,render:aL.get(y)};if(!aP){var A=aL.getStrings();aM.items=[{cssClass:ak,label:A[o]},{cssClass:L,label:A[t]}];}return ai.merge(aM,aO);},_setToolbar:function(aM){var aL=this;var A=aL.getStrings();return ai.merge({activeState:false,bubbleTargets:aL,children:[{handler:ai.bind(aL._handleCancelEvent,aL),label:A[ac]}]},aM);},_uiSetAvailableFields:function(aN){var A=this;var aM=A.fieldsNode;if(aM){var aL=ai.getDoc().invoke(I);aK.each(aN,function(aO){aL.appendChild(aO.get(u));});aM.setContent(A.fieldsContainer.setContent(aL));}},_uiSetFields:function(aL){var A=this;if(A.get(aE)){A.plotFields();}}}});ai.DiagramBuilderBase=aA;},"@VERSION@",{skinnable:true,requires:["aui-tabs","aui-property-list","collection","dd"]});AUI.add("aui-diagram-builder-impl",function(aB){var aq=aB.Lang,d=aq.isArray,a0=aq.isBoolean,N=aq.isObject,a4=aq.isString,aw=aB.WidgetStdMod,be=aB.Array,ao="activeElement",ab="availableField",ae="availableFields",E="backspace",am="boolean",y="boundary",s="boundingBox",ba="builder",av="cancel",ax="canvas",aQ="click",a5="closeEvent",K="closeMessage",a7="condition",S="connector",l="connectors",az="content",V="controls",aN="controlsToolbar",T="createDocumentFragment",aL="data",ag="delete",aJ="deleteConnectorsMessage",q="deleteNodesMessage",aT="description",L="diagram",ay="diagram-builder",aF="diagramNode",a8="diagram-node-manager",G="diagram-node",aX="dragNode",ad="dragging",H="editEvent",Q="editMessage",W="editing",aS="end",a="esc",aZ="field",t="fields",aD="fieldsDragConfig",aA="fork",ak="graphic",aY="height",aH="highlightBoundaryStroke",R="highlightDropZones",c="highlighted",aP="id",v="join",Y="keydown",aC="label",B="lock",u="mouseenter",an="mouseleave",p="name",r="node",aI="p1",aG="p2",f="parentNode",n="pencil",aM="radius",at="records",m="recordset",bb="rendered",P="required",a3="selected",aW="shape",af="shapeBoundary",j="shapeInvite",O="showSuggestConnector",X="source",aK="start",al="state",x="stroke",aV="suggest",aO="suggestConnectorOverlay",k="target",J="task",o="transition",aa="transitions",g="type",ar="visible",U="width",D="xy",C="zIndex",bd="-",i=".",Z="",h="#",M="_",z=aB.getClassName,w=z(L,ba,V),a2=z(L,ba,aZ),ap=z(L,r),b=z(L,r,az),aR=z(L,r,W),ac=z(L,r,aC),bc=z(L,r,a3),aU=z(L,r,aW,y),e=z(L,r,aV,S),au=function(bh,A){var bg=d(bh)?bh:bh.get(s).getXY();return[bg[0]+A[0],bg[1]+A[1]];},a9=function(bi,bh){var bg=bh[0]-bi[0],A=bh[1]-bi[1];return Math.sqrt(bg*bg+A*A);},aj=function(bq,bo){var bm=bq.hotPoints,bl=bo.hotPoints,bt=bq.get(s).getXY(),br=bo.get(s).getXY(),bi,bg,bj,bh,bs=Infinity,bk=[[0,0],[0,0]];for(bj=0,bi=bm.length;bj<bi;bj++){var bp=bm[bj],bv=au(bt,bp);for(bh=0,bg=bl.length;bh<bg;bh++){var bn=bl[bh],bu=au(br,bn),A=a9(bu,bv);if(A<bs){bk[0]=bp;bk[1]=bn;bs=A;}}}return bk;},aE=function(A,bh){var bg=d(bh)?bh:bh.getXY();var bi=d(A)?A:A.getXY();return be.map(bi,function(bk,bj){return Math.max(0,bk-bg[bj]);});},I=function(A){return aB.instanceOf(A,aB.Connector);},a6=function(A){return aB.instanceOf(A,aB.DataSet);},ah=function(A){return aB.instanceOf(A,aB.DiagramBuilderBase);},a1=function(A){return aB.instanceOf(A,aB.DiagramNode);};var F=aB.Component.create({NAME:ay,ATTRS:{connector:{setter:"_setConnector",value:null},fieldsDragConfig:{value:null,setter:"_setFieldsDragConfig",validator:N},graphic:{valueFn:function(){return new aB.Graphic();},validator:N},highlightDropZones:{validator:a0,value:true},strings:{value:{addNode:"Add node",cancel:"Cancel",deleteConnectorsMessage:"Are you sure you want to delete the selected connector(s)?",deleteNodesMessage:"Are you sure you want to delete the selected node(s)?",propertyName:"Property Name",save:"Save",settings:"Settings",value:"Value"}},showSuggestConnector:{validator:a0,value:true},suggestConnectorOverlay:{value:null,setter:"_setSuggestConnectorOverlay"}},EXTENDS:aB.DiagramBuilderBase,FIELDS_TAB:0,SETTINGS_TAB:1,prototype:{editingConnector:null,editingNode:null,publishedSource:null,publishedTarget:null,selectedConnector:null,selectedNode:null,initializer:function(){var A=this;
A.after({render:A.syncConnectionsUI});A.on({cancel:A._onCancel,"drag:drag":A._onDrag,"drag:end":A._onDragEnd,"drop:hit":A._onDropHit,save:A._onSave});aB.DiagramNodeManager.on({publishedSource:function(bg){A.publishedTarget=null;A.publishedSource=bg.publishedSource;}});A.handlerKeyDown=aB.getDoc().on(Y,aB.bind(A._afterKeyEvent,A));A.dropContainer.delegate(aQ,aB.bind(A._onNodeClick,A),i+ap);A.dropContainer.delegate(u,aB.bind(A._onNodeMouseEnter,A),i+ap);A.dropContainer.delegate(an,aB.bind(A._onNodeMouseLeave,A),i+ap);},renderUI:function(){var A=this;aB.DiagramBuilder.superclass.renderUI.apply(this,arguments);A._renderGraphic();},syncUI:function(){var A=this;aB.DiagramBuilder.superclass.syncUI.apply(this,arguments);A._setupFieldsDrag();A.connector=A.get(S);},syncConnectionsUI:function(){var A=this;A.get(t).each(function(bg){bg.syncConnectionsUI();});},clearFields:function(){var bg=this;var A=[];bg.get(t).each(function(bh){A.push(bh);});be.each(A,function(bh){bh.destroy();});A=bg.editingConnector=bg.editingNode=bg.selectedNode=null;},closeEditProperties:function(){var A=this;var bg=A.editingNode;var bh=A.tabView;bh.selectTab(aB.DiagramBuilder.FIELDS_TAB);bh.disableTab(aB.DiagramBuilder.SETTINGS_TAB);if(bg){bg.get(s).removeClass(aR);}A.editingConnector=A.editingNode=null;},connect:function(bg,bi,bh){var A=this;if(a4(bg)){bg=aB.Widget.getByNode(h+aB.DiagramNode.buildNodeId(bg));}if(a4(bi)){bi=aB.Widget.getByNode(h+aB.DiagramNode.buildNodeId(bi));}if(bg&&bi){bg.connect(bi.get(p),bh);}return A;},connectAll:function(bg){var A=this;be.each(bg,function(bh){if(bh.hasOwnProperty(X)&&bh.hasOwnProperty(k)){A.connect(bh.source,bh.target,bh.connector);}});return A;},createField:function(bg){var A=this;if(!a1(bg)){bg.builder=A;bg.bubbleTargets=A;bg=new (A.getFieldClass(bg.type||r))(bg);}return bg;},deleteSelectedConnectors:function(){var bg=this;var A=bg.getStrings();var bh=bg.getSelectedConnectors();if(bh.length&&confirm(A[aJ])){be.each(bh,function(bi){var bj=bi.get(o);aB.DiagramNode.getNodeByName(bj.source).disconnect(bj);});bg.stopEditing();}},deleteSelectedNode:function(){var bg=this;var A=bg.getStrings();var bh=bg.selectedNode;if(bh&&!bh.get(P)&&confirm(A[q])){bh.close();bg.editingNode=bg.selectedNode=null;bg.stopEditing();}},destructor:function(bg){var A=this;A.get(aO).destroy();},eachConnector:function(bg){var A=this;A.get(t).each(function(bh){bh.get(aa).each(function(bi){bg.call(A,bh.getConnector(bi),bi,bh);});});},editConnector:function(bg){var A=this;if(bg){var bh=A.tabView;A.closeEditProperties();bh.enableTab(aB.DiagramBuilder.SETTINGS_TAB);bh.selectTab(aB.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(m,bg.getProperties());A.editingConnector=A.selectedConnector=bg;}},editNode:function(bh){var A=this;if(bh){var bg=A.tabView;A.closeEditProperties();bg.enableTab(aB.DiagramBuilder.SETTINGS_TAB);bg.selectTab(aB.DiagramBuilder.SETTINGS_TAB);A.propertyList.set(m,bh.getProperties());bh.get(s).addClass(aR);A.editingNode=A.selectedNode=bh;}},getFieldClass:function(bh){var A=this;var bg=aB.DiagramBuilder.types[bh];if(bg){return bg;}else{aB.log("The field type: ["+bh+"] couldn't be found.");return null;}},getNodesByTransitionProperty:function(bi,bh){var A=this;var bg=[];A.get(t).each(function(bj){bj.get(aa).each(function(bk){if(bk[bi]===bh){bg.push(bj);return false;}});});return bg;},getSelectedConnectors:function(){var A=this;var bg=[];A.eachConnector(function(bh){if(bh.get(a3)){bg.push(bh);}});return bg;},getSourceNodes:function(bg){var A=this;return A.getNodesByTransitionProperty(k,bg.get(p));},hideSuggestConnetorOverlay:function(bh,bg){var A=this;A.connector.hide();A.get(aO).hide();A.fieldsDrag.dd.set(B,false);},isAbleToConnect:function(){var A=this;return !!(A.publishedSource&&A.publishedTarget);},isFieldsDrag:function(bg){var A=this;return(bg===A.fieldsDrag.dd);},plotField:function(bg){var A=this;if(!bg.get(bb)){bg.render(A.dropContainer);}},select:function(bg){var A=this;A.unselectNodes();A.selectedNode=bg.set(a3,true).focus();},showSuggestConnetorOverlay:function(bg){var A=this;A.get(aO).set(D,bg||A.connector.get(aG)).show().get(s).addClass(e);A.fieldsDrag.dd.set(B,true);},stopEditing:function(){var A=this;A.unselectConnectors();A.unselectNodes();A.closeEditProperties();},toJSON:function(){var A=this;var bg={nodes:[]};A.get(t).each(function(bi){var bh={transitions:[]};be.each(bi.SERIALIZABLE_ATTRS,function(bj){bh[bj]=bi.get(bj);});bi.get(aa).each(function(bk){var bj=bi.getConnector(bk);bk.connector=bj.toJSON();bh.transitions.push(bk);});bg.nodes.push(bh);});return bg;},unselectConnectors:function(){var A=this;be.each(A.getSelectedConnectors(),function(bg){bg.set(a3,false);});},unselectNodes:function(){var A=this;var bg=A.selectedNode;if(bg){bg.set(a3,false);}A.selectedNode=null;},_afterKeyEvent:function(bg){var A=this;if(bg.hasModifier()||aB.getDoc().get(ao).test(":input,td")){return;}if(bg.isKey(a)){A._onEscKey(bg);}else{if(bg.isKey(E)||bg.isKey(ag)){A._onDeleteKey(bg);}}},_onCancel:function(bg){var A=this;A.closeEditProperties();},_onDeleteKey:function(bg){var A=this;A.deleteSelectedConnectors();A.deleteSelectedNode();bg.halt();},_onDrag:function(bh){var A=this;var bg=bh.target;if(A.isFieldsDrag(bg)){var bi=aB.Widget.getByNode(bg.get(aX));bi.alignTransitions();be.each(A.getSourceNodes(bi),function(bj){bj.alignTransitions();});}},_onDragEnd:function(bh){var A=this;var bg=bh.target;var bi=aB.Widget.getByNode(bg.get(aX));if(bi&&A.isFieldsDrag(bg)){bi.set(D,bi.getLeftTop());}},_onDropHit:function(bh){var A=this;var bg=bh.drag;if(A.isAvailableFieldsDrag(bg)){var bj=bg.get(r).getData(ab);var bi=A.addField({xy:aE(bg.lastXY,A.dropContainer),type:bj.get(g)});A.select(bi);}},_onEscKey:function(bg){var A=this;A.hideSuggestConnetorOverlay();A.stopEditing();bg.halt();},_onCanvasClick:function(bg){var A=this;A.stopEditing();A.hideSuggestConnetorOverlay();},_onNodeClick:function(bg){var A=this;var bh=aB.Widget.getByNode(bg.currentTarget);A.select(bh);A._onNodeEdit(bg);},_onNodeEdit:function(bg){var A=this;if(!bg.target.ancestor(i+b,true)){return;
}var bh=aB.Widget.getByNode(bg.currentTarget);if(bh){A.editNode(bh);}},_onNodeMouseEnter:function(bg){var A=this;var bh=aB.Widget.getByNode(bg.currentTarget);bh.set(c,true);},_onNodeMouseLeave:function(bh){var A=this;var bg=A.publishedSource;var bi=aB.Widget.getByNode(bh.currentTarget);if(!bg||!bg.boundaryDragDelegate.dd.get(ad)){bi.set(c,false);}},_onSave:function(bh){var A=this;var bg=A.editingNode;var bi=A.editingConnector;var bj=A.propertyList.get(m);if(bg){be.each(bj.get(at),function(bk){var bl=bk.get(aL);bg.set(bl.attributeName,bl.value);});}else{if(bi){be.each(bj.get(at),function(bk){var bl=bk.get(aL);bi.set(bl.attributeName,bl.value);});}}},_onSuggestConnectorNodeClick:function(bi){var A=this;var bj=bi.currentTarget.getData(ab);var bg=A.connector;var bh=A.addField({type:bj.get(g),xy:bg.toCoordinate(bg.get(aG))});A.hideSuggestConnetorOverlay();A.publishedSource.connectNode(bh);},_renderGraphic:function(){var A=this;var bg=A.get(ak);bg.render(A.get(ax));aB.one(bg.get(r)).on(aQ,aB.bind(A._onCanvasClick,A));},_setConnector:function(bh){var A=this;if(!I(bh)){var bg=A.get(ax).getXY();bh=new aB.Connector(aB.merge({builder:A,graphic:A.get(ak),lazyDraw:true,p1:bg,p2:bg,shapeHover:null,showName:false},bh));}return bh;},_setFieldsDragConfig:function(bh){var A=this;var bg=A.dropContainer;return aB.merge({bubbleTargets:A,container:bg,dragConfig:{plugins:[{cfg:{constrain:bg},fn:aB.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aB.Plugin.DDWinScroll}]},nodes:i+ap},bh||{});},_setSuggestConnectorOverlay:function(bh){var A=this;if(!bh){var bg=aB.getDoc().invoke(T);be.each(A.get(ae),function(bj){var bi=bj.get(r);bg.appendChild(bi.clone().setData(ab,bi.getData(ab)));});bh=new aB.Overlay({bodyContent:bg,render:true,visible:false,zIndex:10000});bh.get(s).delegate(aQ,aB.bind(A._onSuggestConnectorNodeClick,A),i+a2);}return bh;},_setupFieldsDrag:function(){var A=this;A.fieldsDrag=new aB.DD.Delegate(A.get(aD));}}});aB.DiagramBuilder=F;aB.DiagramBuilder.types={};var ai=aB.Component.create({NAME:a8,EXTENDS:aB.Base});aB.DiagramNodeManager=new ai();var bf=aB.Component.create({NAME:G,UI_ATTRS:[c,p,P,a3],ATTRS:{builder:{validator:ah},connectors:{valueFn:"_createDataSet",writeOnce:true},controlsToolbar:{validator:N,valueFn:"_valueControlsToolbar"},description:{value:Z,validator:a4},graphic:{writeOnce:true,validator:N},height:{value:60},highlighted:{validator:a0,value:false},name:{valueFn:function(){var A=this;return A.get(g)+(++aB.Env._uidx);},validator:a4},required:{value:false,validator:a0},selected:{value:false,validator:a0},shapeBoundary:{validator:N,valueFn:"_valueShapeBoundary"},highlightBoundaryStroke:{validator:N,value:{weight:7,color:"#484B4C",opacity:0.25}},shapeInvite:{validator:N,value:{radius:12,type:"circle",stroke:{weight:6,color:"#ff6600",opacity:0.8},fill:{color:"#ffd700",opacity:0.8}}},strings:{value:{closeMessage:"Close",connectMessage:"Connect",description:"Description",editMessage:"Edit",name:"Name",type:"Type"}},tabIndex:{value:1},transitions:{value:null,writeOnce:true,setter:"_setTransitions"},type:{value:r,validator:a4},width:{value:60},zIndex:{value:100}},EXTENDS:aB.Overlay,CIRCLE_POINTS:[[35,20],[28,33],[14,34],[5,22],[10,9],[24,6],[34,16],[31,30],[18,35],[6,26],[7,12],[20,5],[33,12],[34,26],[22,35],[9,30],[6,16],[16,6],[30,9],[35,22],[26,34],[12,33],[5,20],[12,7],[26,6],[35,18],[30,31],[16,34],[6,24],[9,10],[22,5],[34,14],[33,28],[20,35],[7,28],[6,14],[18,5],[31,10],[34,24],[24,34],[10,31],[5,18],[14,6],[28,8],[35,20],[28,33],[14,34],[5,22],[10,8],[25,6],[34,16],[31,30],[18,35],[6,26],[8,12],[20,5],[33,12],[33,27],[22,35],[8,30],[6,15],[16,6],[30,9],[35,23],[26,34],[12,32],[5,20],[12,7],[27,7],[35,18],[29,32],[15,34]],DIAMOND_POINTS:[[30,5],[35,10],[40,15],[45,20],[50,25],[55,30],[50,35],[45,40],[40,45],[35,50],[30,55],[25,50],[20,45],[15,40],[10,35],[5,30],[10,25],[15,20],[20,15],[25,10]],SQUARE_POINTS:[[5,5],[10,5],[15,5],[20,5],[25,5],[30,5],[35,5],[40,5],[50,5],[55,5],[60,5],[65,5],[65,10],[65,15],[65,20],[65,25],[65,30],[65,35],[65,40],[65,45],[65,50],[65,55],[65,60],[65,65],[60,65],[55,65],[50,65],[45,65],[40,65],[35,65],[30,65],[25,65],[20,65],[15,65],[10,65],[5,65],[5,60],[5,55],[5,50],[5,45],[5,40],[5,35],[5,30],[5,25],[5,20],[5,15],[5,10]],getNodeByName:function(A){return aB.Widget.getByNode(h+aB.DiagramNode.buildNodeId(A));},buildNodeId:function(A){return aF+M+aZ+M+A.replace(/[^a-z0-9.:_\-]/ig,"_");},prototype:{LABEL_TEMPLATE:'<div class="'+ac+'">{label}</div>',boundary:null,hotPoints:[[0,0]],CONTROLS_TEMPLATE:'<div class="'+w+'"></div>',SERIALIZABLE_ATTRS:[aT,p,P,g,U,aY,C,D],initializer:function(){var A=this;A.after({"dataset:remove":aB.bind(A._afterDataSetRemove,A),render:A._afterRender});A.on({nameChange:A._onNameChange});A.publish({connectDrop:{defaultFn:A.connectDrop},connectEnd:{defaultFn:A.connectEnd},connectMove:{defaultFn:A.connectMove},connectOutTarget:{defaultFn:A.connectOutTarget},connectOverTarget:{defaultFn:A.connectOverTarget},connectStart:{defaultFn:A.connectStart},boundaryMouseEnter:{},boundaryMouseLeave:{}});A.get(s).addClass(ap+bd+A.get(g));},destructor:function(){var A=this;A.eachConnector(function(bg,bh,bi){bi.removeTransition(bg.get(o));});A.invite.destroy();A.get(ak).destroy();A.get(ba).removeField(A);},addTransition:function(bh){var A=this;var bg=A.get(aa);bh=A.prepareTransition(bh);if(!bg.containsKey(bh.uid)){bh.uid=aB.guid();bg.add(bh.uid,bh);}return bh;},alignTransition:function(bh){var A=this;var bi=aB.DiagramNode.getNodeByName(bh.target);if(bi){var bg=aj(A,bi);bh=aB.merge(bh,{sourceXY:bg[0],targetXY:bg[1]});A.getConnector(bh).setAttrs({p1:au(A,bh.sourceXY),p2:au(bi,bh.targetXY)});}},alignTransitions:function(){var A=this;A.get(aa).each(aB.bind(A.alignTransition,A));},close:function(){var A=this;return A.destroy();},connect:function(bk,bi){var A=this;bk=A.addTransition(bk);var bg=null;var bl=aB.DiagramNode.getNodeByName(bk.target);if(bl){if(!A.isTransitionConnected(bk)){var bh=A.get(ba);var bj=aj(A,bl);aB.mix(bk,{sourceXY:bj[0],targetXY:bj[1]});bg=new aB.Connector(aB.merge({builder:bh,graphic:bh.get(ak),transition:bk},bi));
A.get(l).add(bk.uid,bg);}}A.alignTransition(bk);return bg;},connectDrop:function(bg){var A=this;A.connectNode(bg.publishedTarget);},connectEnd:function(bj){var A=this;var bi=bj.target;var bg=A.get(ba);var bh=bg.publishedSource;if(!bg.isAbleToConnect()&&bg.get(O)&&bg.connector.get(ar)){bg.showSuggestConnetorOverlay();}else{bg.connector.hide();bh.invite.set(ar,false);}if(bg.get(R)){bg.get(t).each(function(bk){bk.set(c,false);});}},connectMove:function(bi){var A=this;var bh=A.get(ba);var bj=bi.mouseXY;bh.connector.set(aG,bj);if(bh.publishedTarget){var bg=A.invite;var bk=bg.get(aM)||0;if(!bg.get(ar)){bg.set(ar,true);}bg.setXY([bj[0]-bk,bj[1]-bk]);}},connectNode:function(bh){var bg=this;var A=bg.boundaryDragDelegate.dd;bg.connect(bg.prepareTransition({sourceXY:aE(A.startXY,bg.get(s)),target:bh.get(p),targetXY:aE(A.mouseXY,bh.get(s))}));},connectOutTarget:function(bh){var A=this;var bg=A.get(ba);bg.publishedTarget=null;bg.publishedSource.invite.set(ar,false);},connectOverTarget:function(bh){var A=this;var bg=A.get(ba);if(bg.publishedSource!==A){bg.publishedTarget=A;}},connectStart:function(bh){var A=this;var bg=A.get(ba);bg.connector.show().set(aI,bh.startXY);if(bg.get(R)){bg.get(t).each(function(bi){bi.set(c,true);});}aB.DiagramNodeManager.fire("publishedSource",{publishedSource:A});},disconnect:function(bg){var A=this;if(A.isTransitionConnected(bg)){A.removeTransition(bg);}},eachConnector:function(bi){var A=this;var bj=[],bg=[].concat(A.get(l).values),bh=bg.length;be.each(A.get(ba).getSourceNodes(A),function(bk){bk.get(l).each(function(bl){if(A.get(p)===bl.get(o).target){bj.push(bk);bg.push(bl);}});});be.each(bg,function(bk,bl){bi.call(A,bk,bl,(bl<bh)?A:bj[bl-bh]);});bg=bj=null;return bg;},getConnector:function(bg){var A=this;return A.get(l).item(bg.uid);},getContainer:function(){var A=this;return(A.get(ba).dropContainer||A.get(s).get(f));},getLeftTop:function(){var A=this;return aE(A.get(s),A.getContainer());},getProperties:function(){var A=this;var bg=A.getPropertyModel();be.each(bg,function(bj){var bi=A.get(bj.attributeName),bh=aq.type(bi);if(bh===am){bi=String(bi);}bj.value=bi;});return bg;},getPropertyModel:function(){var bg=this;var A=bg.getStrings();return[{attributeName:aT,editor:new aB.TextAreaCellEditor(),name:A[aT]},{attributeName:p,editor:new aB.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[p]},{attributeName:g,editor:false,name:A[g]}];},isBoundaryDrag:function(bg){var A=this;return(bg===A.boundaryDragDelegate.dd);},isTransitionConnected:function(bg){var A=this;return A.get(l).containsKey(bg.uid);},prepareTransition:function(bh){var A=this;var bg={source:A.get(p),target:null,uid:aB.guid()};if(a4(bh)){bg.target=bh;}else{if(N(bh)){bg=aB.merge(bg,bh);}}return bg;},removeTransition:function(bg){var A=this;return A.get(aa).removeKey(bg.uid);},renderShapeBoundary:function(){var A=this;var bg=A.boundary=A.get(ak).addShape(A.get(af));return bg;},renderShapeInvite:function(){var A=this;var bg=A.invite=A.get(ba).get(ak).addShape(A.get(j));bg.set(ar,false);return bg;},syncConnectionsUI:function(){var A=this;A.get(aa).each(function(bg){A.connect(bg,bg.connector);});},_afterDataSetRemove:function(bh){var A=this;var bg=bh.target;if(bg===A.get(aa)){A.get(l).removeKey(bh.prevVal.uid);}else{if(bg===A.get(l)){bh.prevVal.destroy();}}},_afterRender:function(bg){var A=this;A.setStdModContent(aw.BODY,Z,aw.AFTER);A._renderGraphic();A._renderControls();A._renderLabel();A._uiSetHighlighted(A.get(c));},_bindBoundaryEvents:function(){var A=this;A.boundary.detachAll().on({mouseenter:aB.bind(A._onBoundaryMouseEnter,A),mouseleave:aB.bind(A._onBoundaryMouseLeave,A)});},_createDataSet:function(){var A=this;return new aB.DataSet({bubbleTargets:A});},_handleCloseEvent:function(bg){var A=this;A.get(ba).deleteSelectedNode();},_handleConnectStart:function(bg){var A=this;A.fire("connectStart",{startXY:bg});},_handleConnectMove:function(bh){var A=this;var bg=A.get(ba);A.fire("connectMove",{mouseXY:bh,publishedSource:bg.publishedSource});},_handleConnectEnd:function(){var A=this;var bg=A.get(ba);var bh=bg.publishedSource;var bi=bg.publishedTarget;if(bh&&bi){A.fire("connectDrop",{publishedSource:bh,publishedTarget:bi});}A.fire("connectEnd",{publishedSource:bh});},_handleConnectOutTarget:function(bi){var A=this;var bg=A.get(ba);var bh=bg.publishedSource;if(bh){A.fire("connectOutTarget",{publishedSource:bh});}},_handleConnectOverTarget:function(){var A=this;var bg=A.get(ba);var bh=bg.publishedSource;if(bh){A.fire("connectOverTarget",{publishedSource:bh});}},_handleEditEvent:function(bg){var A=this;A.get(ba).editNode(A);},_onBoundaryDrag:function(bg){var A=this;A._handleConnectMove(A.boundaryDragDelegate.dd.mouseXY);},_onBoundaryDragEnd:function(bg){var A=this;A._handleConnectEnd();bg.target.get(aX).show();},_onBoundaryDragStart:function(bg){var A=this;A._handleConnectStart(A.boundaryDragDelegate.dd.startXY);bg.target.get(aX).hide();},_onBoundaryMouseEnter:function(bg){var A=this;A.fire("boundaryMouseEnter",{domEvent:bg});A._handleConnectOverTarget();},_onBoundaryMouseLeave:function(bg){var A=this;A.fire("boundaryMouseLeave",{domEvent:bg});A._handleConnectOutTarget();},_onNameChange:function(bg){var A=this;A.eachConnector(function(bh,bi,bj){var bk=bh.get(o);bk[(A===bj)?X:k]=bg.newVal;bh.set(o,bk);});},_renderControls:function(){var A=this;var bg=A.get(s);A.controlsNode=aB.Node.create(A.CONTROLS_TEMPLATE).appendTo(bg);},_renderControlsToolbar:function(bg){var A=this;A.controlsToolbar=new aB.Toolbar(A.get(aN)).render(A.controlsNode);A._uiSetRequired(A.get(P));},_renderGraphic:function(){var A=this;A.set(ak,new aB.Graphic({height:A.get(aY),render:A.bodyNode,width:A.get(U)}));A.renderShapeInvite();A.renderShapeBoundary().addClass(aU);A._bindBoundaryEvents();A._setupBoundaryDrag();},_renderLabel:function(){var A=this;A.labelNode=aB.Node.create(aq.sub(A.LABEL_TEMPLATE,{label:A.get("name")}));A.get("contentBox").placeAfter(A.labelNode);},_setTransitions:function(bh){var A=this;if(!a6(bh)){var bg=A._createDataSet();
aB.Array.each(bh,function(bj){var bi=aB.guid();bj=N(bj)?aB.mix(bj,{uid:bi}):{uid:bi,target:bj};bg.add(bi,A.prepareTransition(bj));});bh=bg;}return bh;},_setupBoundaryDrag:function(){var A=this;var bg=A.get(ba);A.boundaryDragDelegate=new aB.DD.Delegate({bubbleTargets:A,container:A.bodyNode,nodes:i+aU,dragConfig:{useShim:false,plugins:[{cfg:{constrain:(bg?bg.get(ax):null)},fn:aB.Plugin.DDConstrained},{cfg:{scrollDelay:150},fn:aB.Plugin.DDWinScroll},{cfg:{borderStyle:"0px",moveOnEnd:false,resizeFrame:false},fn:aB.Plugin.DDProxy}]},on:{"drag:drag":aB.bind(A._onBoundaryDrag,A),"drag:end":aB.bind(A._onBoundaryDragEnd,A),"drag:start":aB.bind(A._onBoundaryDragStart,A)}});aB.Do.after(A._bindBoundaryEvents,A.boundaryDragDelegate.dd,"_unprep",A);},_uiSetHighlighted:function(bh){var A=this;if(A.get(bb)){var bg=bh?A.get(aH):A.get(af+i+x);if(bg){A.boundary.set(x,bg);}}},_uiSetName:function(bh){var A=this;var bg=A.get(s);bg.set(aP,aB.DiagramNode.buildNodeId(bh));if(A.get("rendered")){A.labelNode.setContent(bh);}},_uiSetRequired:function(bi){var bh=this;var bg=bh.getStrings();var A=bh.controlsToolbar;if(A){if(bi){A.remove(a5);}else{A.add({handler:aB.bind(bh._handleCloseEvent,bh),icon:av,id:a5,title:bg[K]});}}},_uiSetSelected:function(bg){var A=this;A.get(s).toggleClass(bc,bg);if(bg&&!A.controlsToolbar){A._renderControlsToolbar();}},_uiSetXY:function(bh){var A=this;var bg=A.getContainer().getXY();this._posNode.setXY([bh[0]+bg[0],bh[1]+bg[1]]);},_valueControlsToolbar:function(bh){var bg=this;var A=bg.getStrings();return{activeState:false,children:[{handler:aB.bind(bg._handleEditEvent,bg),icon:n,id:H,title:A[Q]},{handler:aB.bind(bg._handleCloseEvent,bg),icon:av,id:a5,title:A[K]}]};},_valueShapeBoundary:function(){var A=this;return{height:41,type:"rect",stroke:{weight:7,color:"transparent",opacity:0},width:41};}}});aB.DiagramNode=bf;aB.DiagramBuilder.types[r]=aB.DiagramNode;aB.DiagramNodeState=aB.Component.create({NAME:G,ATTRS:{height:{value:40},type:{value:al},width:{value:40}},EXTENDS:aB.DiagramNode,prototype:{hotPoints:aB.DiagramNode.CIRCLE_POINTS,renderShapeBoundary:function(){var A=this;var bg=A.boundary=A.get(ak).addShape(A.get(af));bg.translate(5,5);return bg;},_valueShapeBoundary:function(){var A=this;return{radius:15,type:"circle",stroke:{weight:7,color:"transparent",opacity:0}};}}});aB.DiagramBuilder.types[al]=aB.DiagramNodeState;aB.DiagramNodeCondition=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:a7},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:function(){var A=this;var bg=A.boundary=A.get(ak).addShape(A.get(af));bg.translate(10,10);bg.rotate(45);return bg;},_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[a7]=aB.DiagramNodeCondition;aB.DiagramNodeStart=aB.Component.create({NAME:G,ATTRS:{type:{value:aK}},EXTENDS:aB.DiagramNodeState});aB.DiagramBuilder.types[aK]=aB.DiagramNodeStart;aB.DiagramNodeEnd=aB.Component.create({NAME:G,ATTRS:{type:{value:aS}},EXTENDS:aB.DiagramNodeState});aB.DiagramBuilder.types[aS]=aB.DiagramNodeEnd;aB.DiagramNodeJoin=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:v},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:aB.DiagramNodeCondition.prototype.renderShapeBoundary,_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[v]=aB.DiagramNodeJoin;aB.DiagramNodeFork=aB.Component.create({NAME:G,ATTRS:{height:{value:60},type:{value:aA},width:{value:60}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.DIAMOND_POINTS,renderShapeBoundary:aB.DiagramNodeCondition.prototype.renderShapeBoundary,_valueShapeBoundary:aB.DiagramNode.prototype._valueShapeBoundary}});aB.DiagramBuilder.types[aA]=aB.DiagramNodeFork;aB.DiagramNodeTask=aB.Component.create({NAME:G,ATTRS:{height:{value:70},type:{value:J},width:{value:70}},EXTENDS:aB.DiagramNodeState,prototype:{hotPoints:aB.DiagramNode.SQUARE_POINTS,renderShapeBoundary:function(){var A=this;var bg=A.boundary=A.get(ak).addShape(A.get(af));bg.translate(8,8);return bg;},_valueShapeBoundary:function(){var A=this;return{height:55,type:"rect",stroke:{weight:7,color:"transparent",opacity:0},width:55};}}});aB.DiagramBuilder.types[J]=aB.DiagramNodeTask;},"@VERSION@",{skinnable:true,requires:["aui-data-set","aui-diagram-builder-base","aui-diagram-builder-connector","overlay"]});AUI.add("aui-diagram-builder-connector",function(i){var U=i.Lang,s=U.isArray,w=U.isBoolean,F=U.isObject,g=U.isString,o=i.Array,S=function(A){return(A*A*A);},R=function(A){return(3*A*A*(1-A));},Q=function(A){return(3*A*(1-A)*(1-A));},O=function(A){return((1-A)*(1-A)*(1-A));},l=function(Y,X,W,aa,Z){var A=X[0]*S(Y)+aa[0]*R(Y)+Z[0]*Q(Y)+W[0]*O(Y);var ab=X[1]*S(Y)+aa[1]*R(Y)+Z[1]*Q(Y)+W[1]*O(Y);return[A,ab];},I=function(A){return i.instanceOf(A,i.Graphic);},d=function(A){return A*180/Math.PI;},h=function(A){return A===0?0:(A<0?-1:1);},C="anchor",L="arrowPoints",N="boundingBox",V="builder",G="click",y="color",q="connector",t="diagramNode",B="fill",z="graphic",H="helper",K="hidden",P="lazyDraw",c="mouseenter",j="mouseleave",x="name",J="nodeName",n="p1",m="p2",e="path",v="region",u="selected",r="shape",b="shapeArrow",p="shapeArrowHover",M="shapeArrowSelected",D="shapeHover",k="shapeSelected",E="showName",f="stroke",T="visible",a=i.getClassName(H,K);i.PolygonUtil={ARROW_POINTS:[[-12,-6],[-8,0],[-12,6],[6,0]],drawArrow:function(X,Y,aa,W,Z,ab){var A=this;var ac=Math.atan2(Z-aa,W-Y);X.moveTo(W,Z);W=W-5*Math.cos(ac);Z=Z-5*Math.sin(ac);A.drawPolygon(X,A.translatePoints(A.rotatePoints(ab||A.ARROW_POINTS,ac),W,Z));},drawPolygon:function(W,X){var A=this;W.moveTo(X[0][0],X[0][1]);o.each(X,function(Z,Y){if(Y>0){W.lineTo(X[Y][0],X[Y][1]);}});W.lineTo(X[0][0],X[0][1]);},translatePoints:function(X,W,Z){var A=this;var Y=[];o.each(X,function(ab,aa){Y.push([X[aa][0]+W,X[aa][1]+Z]);});return Y;},rotatePoints:function(W,Y){var A=this;var X=[];
o.each(W,function(aa,Z){X.push(A.rotatePoint(Y,W[Z][0],W[Z][1]));});return X;},rotatePoint:function(W,A,X){return[(A*Math.cos(W))-(X*Math.sin(W)),(A*Math.sin(W))+(X*Math.cos(W))];}};i.Connector=i.Base.create("line",i.Base,[],{SERIALIZABLE_ATTRS:[y,P,x,k,D,n,m],shape:null,shapeArrow:null,initializer:function(X){var A=this;var W=A.get(P);A.after({nameChange:A._afterNameChange,p1Change:A.draw,p2Change:A.draw,selectedChange:A._afterSelectedChange,showNameChange:A._afterShowNameChange,visibleChange:A._afterVisibleChange});A._initShapes();if(!W){A.draw();}A._uiSetVisible(A.get(T));A._uiSetName(A.get(x));A._uiSetSelected(A.get(u),!W);A._uiSetShowName(A.get(E));},destructor:function(){var A=this;A.shape.destroy();A.shapeArrow.destroy();A.get(J).remove();},draw:function(){var ap=this;var Y=ap.shape;var A=ap.shapeArrow;var X=ap.get(n),W=ap.get(m),al=ap.toCoordinate(X),aj=ap.toCoordinate(W),an=al[0],aa=al[1],am=aj[0],Z=aj[1],ag=Math.max(Math.abs(an-am)/2,10),ae=Math.max(Math.abs(aa-Z)/2,10),ad=null,af=8,ao=d(Math.atan2(Z-aa,am-an)),ab=Math.round(Math.abs(ao)/(360/af));if(h(ao)<0){ad=[[an+ag,aa,am-ag,Z,am,Z],[an+ag,aa,am,aa-ae,am,Z],[an,aa-ae,am,aa-ae,am,Z],[an-ag,aa,am,aa-ae,am,Z],[an-ag,aa,am+ag,Z,am,Z]];}else{ad=[[an+ag,aa,am-ag,Z,am,Z],[an+ag,aa,am,aa+ae,am,Z],[an,aa+ae,am,aa+ae,am,Z],[an-ag,aa,am,aa+ae,am,Z],[an-ag,aa,am+ag,Z,am,Z]];}var ac=ad[ab];Y.clear();Y.moveTo(an,aa);Y.curveTo.apply(Y,ac);Y.end();var ai=l(0,[an,aa],[am,Z],[ac[0],ac[1]],[ac[2],ac[3]]),ah=l(0.075,[an,aa],[am,Z],[ac[0],ac[1]],[ac[2],ac[3]]),ak=l(0.5,[an,aa],[am,Z],[ac[0],ac[1]],[ac[2],ac[3]]);A.clear();i.PolygonUtil.drawArrow(A,ah[0],ah[1],ai[0],ai[1],ap.get(L));A.end();if(ap.get(E)){ap.get(J).center(ap.toXY(ak));}return ap;},getProperties:function(){var A=this;var W=A.getPropertyModel();o.each(W,function(X){X.value=A.get(X.attributeName);});return W;},getPropertyModel:function(){var W=this;var X=W.get(C);var A=X?X.get(t).getStrings():{};return[{attributeName:x,editor:new i.TextCellEditor({validator:{rules:{value:{required:true}}}}),name:A[x]}];},hide:function(){var A=this;A.set(T,false);return A;},show:function(){var A=this;A.set(T,true);return A;},toCoordinate:function(W){var A=this;return A._offsetXY(W,-1);},toJSON:function(){var A=this;var W={};o.each(A.SERIALIZABLE_ATTRS,function(X){W[X]=A.get(X);});return W;},toXY:function(W){var A=this;return A._offsetXY(W,1);},_afterNameChange:function(W){var A=this;A._uiSetName(W.newVal);A.draw();},_afterSelectedChange:function(W){var A=this;A._uiSetSelected(W.newVal);},_afterShowNameChange:function(W){var A=this;A._uiSetShowName(W.newVal);},_afterVisibleChange:function(W){var A=this;A._uiSetVisible(W.newVal);},_initShapes:function(){var A=this;var W=A.shape=A.get(z).addShape(A.get(r));var X=A.shapeArrow=A.get(z).addShape(A.get(b));W.on(G,i.bind(A._onShapeClick,A));W.on(c,i.bind(A._onShapeMouseEnter,A));W.on(j,i.bind(A._onShapeMouseLeave,A));X.on(G,i.bind(A._onShapeClick,A));A.get(J).on(G,i.bind(A._onShapeClick,A));},_offsetXY:function(Y,X){var A=this;var W=A.get(z).getXY();return[Y[0]+W[0]*X,Y[1]+W[1]*X];},_onShapeClick:function(Y){var A=this;var W=A.get(V);var X=A.get(u);if(W){if(Y.hasModifier()){W.closeEditProperties();}else{W.unselectConnectors();if(X){W.closeEditProperties();}else{W.editConnector(A);}}}A.set(u,!X);},_onShapeMouseEnter:function(Y){var A=this;if(!A.get(u)){var X=A.get(D);var W=A.get(p);if(X){A._updateShape(A.shape,X);}if(W){A._updateShape(A.shapeArrow,W);}}},_onShapeMouseLeave:function(W){var A=this;if(!A.get(u)){A._updateShape(A.shape,A.get(r));A._updateShape(A.shapeArrow,A.get(b));}},_setNodeName:function(W){var A=this;if(!i.instanceOf(W,i.Node)){W=new i.Template(W).render();A.get(V).canvas.append(W.unselectable());}return W;},_setShape:function(W){var A=this;return i.merge({type:e,stroke:{color:A.get(y),weight:2,opacity:1}},W);},_setShapeArrow:function(W){var A=this;return i.merge({type:e,fill:{color:A.get(y),opacity:1},stroke:{color:A.get(y),weight:2,opacity:1}},W);},_uiSetName:function(W){var A=this;A.get(J).html(W);},_uiSetSelected:function(X,W){var A=this;A._updateShape(A.shape,X?A.get(k):A.get(r),W);A._updateShape(A.shapeArrow,X?A.get(M):A.get(b),W);},_uiSetShowName:function(W){var A=this;A.get(J).toggleClass(a,!W);},_uiSetVisible:function(W){var A=this;A.shape.set(T,W);A.shapeArrow.set(T,W);A._uiSetShowName(W&&A.get(E));},_updateShape:function(X,Y,W){var A=this;if(Y.hasOwnProperty(B)){X.set(B,Y[B]);}if(Y.hasOwnProperty(f)){X.set(f,Y[f]);}if(W!==false){A.draw();}}},{ATTRS:{arrowPoints:{value:i.PolygonUtil.ARROW_POINTS},builder:{},color:{value:"#27aae1",validator:g},graphic:{validator:I},lazyDraw:{value:false,validator:w},name:{valueFn:function(){var A=this;return q+(++i.Env._uidx);},validator:g},nodeName:{setter:"_setNodeName",value:['<span class="{$ans}diagram-builder-connector-name"></span>'],writeOnce:true},p1:{value:[0,0],validator:s},p2:{value:[0,0],validator:s},selected:{value:false,validator:w},shape:{value:null,setter:"_setShape"},shapeArrow:{value:null,setter:"_setShapeArrow"},shapeArrowHover:{value:{fill:{color:"#ffd700"},stroke:{color:"#ffd700",weight:5,opacity:0.8}}},shapeArrowSelected:{value:{fill:{color:"#ff6600"},stroke:{color:"#ff6600",weight:5,opacity:0.8}}},shapeHover:{value:{stroke:{color:"#ffd700",weight:5,opacity:0.8}}},shapeSelected:{value:{stroke:{color:"#ff6600",weight:5,opacity:0.8}}},showName:{validator:w,value:true},transition:{value:{},validator:F},visible:{validator:w,value:true}}});},"@VERSION@",{skinnable:true,requires:["aui-base","aui-template","arraylist-add","arraylist-filter","json","graphics","dd"]});AUI.add("aui-diagram-builder",function(a){},"@VERSION@",{use:["aui-diagram-builder-base","aui-diagram-builder-impl"],skinnable:true});